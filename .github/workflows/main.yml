name: ðŸŒ¸ Marina Bot CI/CD

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '18.x'

jobs:
  # ðŸŒ¸ Marina Bot Quality Assurance
  quality-check:
    name: ðŸ” Code Quality Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ðŸ›Žï¸ Checkout Code
      uses: actions/checkout@v4
      
    - name: âŽ” Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¥ Install Dependencies
      run: |
        npm install
        npm install -g eslint
        
    - name: ðŸ” ESLint Analysis
      run: |
        npx eslint scripts/ --ext .js --config .eslintrc.json || echo "ESLint completed"
        
    - name: ðŸ“Š Code Structure Check
      run: |
        echo "ðŸŒ¸ Marina Bot Structure Verification"
        [ -f "scripts/cmds/help.js" ] && echo "âœ… Help command found" || echo "âŒ Help command missing"
        [ -f "scripts/cmds/prefix.js" ] && echo "âœ… Prefix command found" || echo "âŒ Prefix command missing"
        [ -f "config.json" ] && echo "âœ… Config file found" || echo "âŒ Config file missing"

  # ðŸ’« Marina Bot Deployment
  deploy:
    name: ðŸš€ Deploy Marina Bot
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ›Žï¸ Checkout Repository
      uses: actions/checkout@v4
      
    - name: âŽ” Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ðŸ“¥ Install Dependencies
      run: npm ci --production
      
    - name: ðŸ”§ Environment Setup
      run: |
        echo "ðŸŒ¸ Setting up Marina Bot environment"
        mkdir -p database/data
        mkdir -p scripts/cmds/tmp
        mkdir -p scripts/events/tmp
        mkdir -p logs
        
    - name: ðŸ“ File Structure Validation
      run: |
        echo "ðŸ’« Validating Marina Bot structure..."
        echo "ðŸ“ Required directories:"
        ls -la scripts/cmds/ | head -10
        echo "ðŸ”§ Core files:"
        [ -f "Goat.js" ] && echo "âœ… Goat.js found" || echo "âŒ Goat.js missing"
        [ -f "config.json" ] && echo "âœ… config.json found" || echo "âŒ config.json missing"
        
    - name: ðŸ§ª Basic Function Test
      run: |
        echo "ðŸŽ€ Testing Marina Bot components..."
        node -e "
          try {
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('config.json', 'utf8'));
            console.log('âœ… Config loaded successfully');
            console.log('ðŸŒ¸ Bot Name:', config.nickNameBot);
            console.log('ðŸ’« Prefix:', config.prefix);
          } catch (e) {
            console.log('âŒ Config error:', e.message);
            process.exit(1);
          }
        "
        
    - name: ðŸ“¦ Create Deployment Package
      run: |
        echo "ðŸŒº Creating deployment package..."
        mkdir -p marina-bot-deploy
        cp -r scripts/ marina-bot-deploy/
        cp -r database/ marina-bot-deploy/
        cp -r languages/ marina-bot-deploy/
        cp -r assets/ marina-bot-deploy/ 2>/dev/null || true
        cp *.js marina-bot-deploy/
        cp *.json marina-bot-deploy/
        cp .gitignore marina-bot-deploy/
        
        echo "ðŸ“ Deployment structure:"
        find marina-bot-deploy -type f -name "*.js" | head -10
        
    - name: ðŸŽ€ Success Notification
      if: success()
      run: |
        echo "ðŸŒ¸ Marina Bot deployment ready!"
        echo "ðŸ’« All quality checks passed"
        echo "ðŸŽ€ Bot can be deployed successfully"
        
    - name: ðŸš¨ Failure Notification
      if: failure()
      run: |
        echo "âŒ Marina Bot deployment failed"
        echo "ðŸ”§ Please check the errors above"

  # ðŸŽ€ Marina Bot Security Scan
  security-scan:
    name: ðŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ›Žï¸ Checkout Code
      uses: actions/checkout@v4
      
    - name: âŽ” Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ðŸ“¥ Install Dependencies
      run: npm ci
      
    - name: ðŸ”’ NPM Audit
      run: npm audit --audit-level moderate || true
      
    - name: ðŸ“ License Check
      run: |
        echo "ðŸ“„ License Information:"
        [ -f "LICENSE" ] && echo "âœ… LICENSE file found" || echo "âš ï¸  No LICENSE file"
        [ -f "package.json" ] && cat package.json | grep -i license || echo "â„¹ï¸  No license in package.json"

  # ðŸŒŠ Marina Bot Auto-Backup
  auto-backup:
    name: ðŸ’¾ Auto Backup
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    
    steps:
    - name: ðŸ›Žï¸ Checkout Code
      uses: actions/checkout@v4
      
    - name: ðŸ“… Create Backup
      run: |
        BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
        echo "ðŸ’¾ Creating backup: marina_backup_$BACKUP_DATE"
        tar -czf marina_backup_$BACKUP_DATE.tar.gz \
          scripts/ \
          database/ \
          languages/ \
          *.js \
          *.json \
          .gitignore \
          README.md 2>/dev/null || true
          
    - name: ðŸ“¤ Upload Backup
      uses: actions/upload-artifact@v4
      with:
        name: marina-backup
        path: marina_backup_*.tar.gz
        retention-days: 7

# ðŸŒ¸ Marina Bot Workflow Notifications
on:
  workflow_run:
    workflows: ["ðŸŒ¸ Marina Bot CI/CD"]
    types:
      - completed
      
jobs:
  notify:
    name: ðŸ“¢ Notification
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'skipped' }}
    
    steps:
    - name: ðŸ”” Workflow Status
      run: |
        echo "ðŸŒ¸ Marina Bot CI/CD Status: ${{ github.event.workflow_run.conclusion }}"
        echo "ðŸ’« Workflow: ${{ github.event.workflow_run.name }}"
        echo "ðŸŽ€ View details: ${{ github.event.workflow_run.html_url }}"
